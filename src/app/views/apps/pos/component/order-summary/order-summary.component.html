<div class="card">
  <div class="card-header">
    <h4 class="card-title">Resumen de Pedido</h4>
    <p class="mb-0">#ORD-{{order.id}}</p>
    <!-- boton para agregar items al pedido -->
    <div class="card-actions float-end">
      <a href="javascript:void(0);" class="btn btn-outline-primary btn-sm"
        (click)="openModal(centered, { centered: true })"><i class="ri-add-line"></i> Agregar
        Ítems</a>
    </div>
  </div>
  <div class="card-body">
    <h5 class="fw-semibold">Total Items <span class="text-muted">({{getQtyItems(order)}})</span></h5>
    @for (item of order.items; track $index) {
    <div class="mt-3 border border-light  p-2 rounded">
      <div class="d-flex flex-wrap align-items-center gap-3">
        <!-- <div class="rounded bg-light avatar-xl d-flex align-items-center justify-content-center">
          <img src="assets/images/food-icon/pic12.png" alt="" class="avatar-xl">
        </div> -->
        <div>
          <a href="javascript:void(0);" class="text-dark fs-15 fw-bold">{{getProductName(item)}}</a>
          <!-- agregar tooltip   -->
          <p class="fs-14 my-1" placement="top" ngbTooltip="{{item.notes}}">{{getNoteMaxLength(item)}}</p>
          <!-- <a href="javascript:void(0);" class="link-primary text-decoration-underline fw-semibold">View Details <i
              class="ri-arrow-right-up-line"></i></a> -->
        </div>
        <div class="ms-lg-auto">
          <div class="input-step border bg-body-secondary p-1 mt-1 rounded d-inline-flex overflow-visible">
            <button type="button" class="minus bg-light text-dark border-0 rounded fs-20 lh-1 h-100"
              (click)="handleMinusValue(item)">-</button>
            <input type="number" class="text-dark text-center border-0 bg-body-secondary rounded h-100" value="1"
              min="0" [(ngModel)]="item.quantity" max="100" readonly="">
            <button type="button" class="plus bg-light text-dark border-0 rounded fs-20 lh-1 h-100"
              (click)="handlePlusValue(item)">+</button>
          </div>
        </div>
      </div>
      <hr>

      <div class="d-flex align-items-center justify-content-between px-1">
        <div>
          <p class="text-dark fw-semibold fs-16 mb-0">${{(item.unitPrice * item.quantity) | number:'1.2-2'}}
            @if (item.quantity > 1) {
            <small class="text-muted ms-1">Por unidad: ${{item.unitPrice | number:'1.2-2'}}</small>
            }
          </p>
        </div>
        <div class="d-flex align-content-center gap-1">
          <div style="cursor: pointer;" (click)="removeItem(item)" data-bs-toggle="tooltip" data-bs-placement="top"
            class="btn btn-soft-danger avatar-sm rounded d-flex align-items-center justify-content-center"><i
              class="ri-delete-bin-5-line align-middle fs-20"></i></div>
        </div>
      </div>
    </div>
    }
    <!-- <div class="position-relative mt-3">
      <div class="form-button">
        <form class="d-flex align-items-center justify-content-center">
          <input type="text" class="form-control border rounded" placeholder="Apply Coupon" required="" value="">
          <button type="button" data-toast="" data-toast-text="Your Promo Code Apply Successfully"
            data-toast-gravity="top" data-toast-position="center" data-toast-classname="success"
            data-toast-duration="3000" class="btn btn-primary ms-2 rounded-2">
            Apply
          </button>
        </form>
      </div>
    </div> -->
    <div class="mt-3">
      <div class="table-responsive">
        <table class="table table-bordered bg-light-subtle">
          <tbody>
            <tr>
              <td>
                <p class="d-flex mb-0 align-items-center gap-1">Items : </p>
              </td>
              <td class="text-end text-dark fw-medium">{{getQtyItems(order)}} (Items)</td>
            </tr>
            <tr>
              <td>
                <p class="d-flex mb-0 align-items-center gap-1"> Subtotal : </p>
              </td>
              <td class="text-end text-dark fw-medium">${{getSubtotal(order) | number:'1.2-2'}}</td>
            </tr>
            <!-- <tr>
              <td>
                <p class="d-flex mb-0 align-items-center gap-1"> Delivery Charge : </p>
              </td>
              <td class="text-end text-dark fw-medium">$00.00</td>
            </tr> -->
            <tr>
              <td>
                <p class="d-flex mb-0 align-items-center gap-1"> Descuento : </p>
              </td>
              <td class="text-end text-dark fw-medium">{{ discount | number:'1.2-2'}}%</td>
            </tr>
            <tr>
              <td>
                <p class="d-flex mb-0 align-items-center gap-1 fw-semibold text-danger"> Total a Pagar : </p>
              </td>
              <td class="text-end text-success fw-semibold">${{order.total * (discount ? 1 - (discount / 100 ) : 1) |
                number:'1.2-2'}}
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
    <h5 class="fw-semibold my-3">Métodos de Pago</h5>
    <form #payForm="ngForm" (change)="onPaymentMethodChange(selectedPayment)">
      <div class="row g-2">
        <div class="col-lg-4">
          <div class="form-check form-checkbox-success ps-0">
            <label for="cash-payment" class="w-100">
              <div class="d-flex align-items-center p-3 rounded gap-2 border">
                <div class="d-flex align-items-center gap-2">
                  <h5 class="mb-0"><i class="ri-cash-fill text-success"></i> Efect.</h5>
                </div>
                <div class="ms-auto">
                  <input class="form-check-input float-end" type="radio" id="cash-payment" name="payment"
                    [value]="'EFECTIVO'" [(ngModel)]="selectedPayment"> <!-- data-binding -->
                </div>
              </div>
            </label>
          </div>
        </div>

        <div class="col-lg-4">
          <div class="form-check form-checkbox-success ps-0">
            <label for="card-payment" class="w-100">
              <div class="d-flex align-items-center p-3 rounded gap-2 border">
                <div class="d-flex align-items-center gap-2">
                  <h5 class="mb-0"><i class="ri-bank-card-fill text-success"></i> Tarj.</h5>
                </div>
                <div class="ms-auto">
                  <input class="form-check-input float-end" type="radio" id="card-payment" name="payment"
                    [value]="'TARJETA'" [(ngModel)]="selectedPayment">
                </div>
              </div>
            </label>
          </div>
        </div>

        <div class="col-lg-4">
          <div class="form-check form-checkbox-success ps-0">
            <label for="upi-payment" class="w-100">
              <div class="d-flex align-items-center p-3 rounded gap-2 border">
                <div class="d-flex align-items-center gap-2">
                  <h5 class="mb-0"><i class="ri-bank-fill text-success"></i> Transf.</h5>
                </div>
                <div class="ms-auto">
                  <input class="form-check-input float-end" type="radio" id="upi-payment" name="payment"
                    [value]="'TRANSFERENCIA'" [(ngModel)]="selectedPayment">
                </div>
              </div>
            </label>
          </div>
        </div>
      </div>

      <!-- si querés reaccionar al cambio sin submit, podés poner (change) en cada input -->
      <!-- <button type="submit" class="btn btn-sm btn-outline-primary mt-2">Confirmar método</button> -->
    </form>

    <div class=" gap-1 hstack mt-3">
      <a href="javascript:void(0);" class="btn btn-danger w-100" (click)="cancelOrder()"><i
          class="ri-close-circle-line"></i> Cancelar Pedido</a>
      <a href="javascript:void(0);" class="btn btn-primary w-100" (click)="closeOrder()"><i
          class="ri-shopping-basket-2-line"></i> {{isEditing ? 'Editar' : 'Mesa Pagada'}}</a>
    </div>
  </div>
</div>

<ng-template #centered let-modal class="modal fade" id="exampleModalCenter" tabindex="-1"
  aria-labelledby="exampleModalCenterTitle" aria-hidden="true">
  <div class="modal-content">
    <div class="modal-header">
      <h5 class="modal-title" id="exampleModalCenterTitle">Agregar Item</h5>
      <button type="button" (click)="modal.close('click')" class="btn-close" data-bs-dismiss="modal"
        aria-label="Close"></button>
    </div>
    <div class="modal-body">
      @if (categoriesProducts.length > 0) {
      <div class="">
        <div class="mb-3">
          <label for="category" class="form-label">Categoría</label>
          <select selectFormInput class="form-control" id="category" data-choices data-choices-groups
            data-placeholder="Select Category" [(ngModel)]="categorySelected"
            (ngModelChange)="filterProductsByCategory()">
            @for (item of categoriesProducts; track item.categoryId) {
            <option [value]="item.categoryId">{{ item.name }}</option>
            }
          </select>
        </div>
      </div>
      }
      @if (productsFiltered.length > 0) {
      <div class="">
        <div class="mb-3">
          <label for="product" class="form-label">Producto</label>
          <select selectFormInput [reloadChoices]="reloadChoices" class="form-control" id="product" data-choices
            data-choices-groups data-placeholder="Select Product" [(ngModel)]="productSelected">
            @for (item of productsFiltered; track item.productId) {
            <option [value]="item.productId">
              {{ item.name }} - $ {{ item.price | number:'1.2-2' }}
            </option>
            }
          </select>
        </div>
      </div>
      }
      <div class="mb-3">
        <label for="seatingCapacity" class="col-form-label">Cantidad:</label>
        <input type="number" class="form-control" id="seatingCapacity" [(ngModel)]="qty" placeholder="Ej: 4">
      </div>
      <div class="mb-3">
        <label for="specialRequest" class="col-form-label">Petición Especial:</label>
        <textarea class="form-control" id="specialRequest" rows="3" placeholder="Escribe aquí tu petición especial..."
          [(ngModel)]="specialRequest"></textarea>
      </div>
    </div>
    <div class="modal-footer">
      <button type="button" class="btn btn-secondary" data-bs-dismiss="modal"
        (click)="modal.close('click')">Cancelar</button>
      <button type="button" class="btn btn-primary" (click)="addItem()"
        [disabled]="productSelected === null">Agregar</button>
    </div>
  </div>
</ng-template>
