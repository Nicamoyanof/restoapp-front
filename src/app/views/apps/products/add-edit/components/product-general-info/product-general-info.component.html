<div class="card">
  <div class="card-header">
    <h4 class="card-title mb-0">{{ isEdit ? 'Editar' : 'Agregar' }} Producto</h4>
  </div>
  <form [formGroup]="formGroup">
    <div class="card-body">
      <div class="row">
        <div class="col-lg-6">
          <div class="mb-3">
            <label for="product-name" class="form-label">Nombre del Producto</label>
            <input type="text" id="product-name" class="form-control" placeholder="Nombre del producto"
              formControlName="name">
            <!-- agregar contador de caracteres (max 150 )-->
            <div class="form-text text-end"><small>
                {{ formGroup.get('name')?.value?.length || 0 }}/150
              </small></div>
            @if (formGroup.get('name')?.invalid && formGroup.get('name')?.touched) {
            <div class="invalid-feedback">
              @if (formGroup.get('name')?.errors?.['required']) {
              <div>El nombre del producto es obligatorio.</div>
              }
              @if (formGroup.values.name.length > 150) {

              <div>El nombre del producto no puede exceder los 150
                caracteres.</div>
              }
            </div>
            }

          </div>

        </div>

        @if (categories.length > 0) {
        <div class="col-lg-6">
          <div class="mb-3">
            <label for="category" class="form-label">Categoría</label>
            <select selectFormInput [defaultValue]="categoryId" [tigerValue]="resetEmitter" class="form-control"
              id="category" data-choices data-choices-groups data-placeholder="Select Category"
              formControlName="categoryId">
              @for (item of categories; track $index) {
              <option [value]="item.categoryId">{{ item.name }}</option>
              }
            </select>
          </div>
        </div>
        }
        <div class="">
          <div class="mb-3">
            <label for="description" class="form-label">Descripción</label>
            <textarea class="form-control bg-light-subtle" id="description" rows="5"
              placeholder="Descripción del producto" formControlName="description"></textarea>
          </div>
        </div>
        <div class="col-md-6">
          <div class="mb-3">
            <label for="product-id" class="form-label">Precio</label>
            <input type="text" class="form-control" mask="separator" [thousandSeparator]="'.'" [decimalMarker]="','"
              id="product-id" class="form-control" placeholder="0,00" formControlName="price">
          </div>
        </div>
        <!-- agregar check de trrackeo de stock -->
        @if (kitchens.length > 0) {
        <div class="col-lg-6">
          <div class="mb-3">
            <label for="kitchen" class="form-label">Cocina</label>
            <select selectFormInput [tigerValue]="resetEmitter" class="form-control" id="kitchen" data-choices
              data-choices-groups data-placeholder="Select Kitchen" formControlName="kitchenId">
              @for (item of kitchens; track $index) {
              <option [value]="item.kitchenId">{{ item.name }}</option>
              }
            </select>
          </div>
        </div>
        }
        <div class="col-md-3">
          <div class="mb-3">
            <label for="track-stock" class="form-label d-block">Rastrear Stock</label>
            <input type="checkbox" id="track-stock" formControlName="trackStock" data-switch="success"
              (change)="onTrackStockChange($event)">
            <label for="track-stock" data-off-label="No"></label>
          </div>
        </div>
      </div>
    </div>
  </form>
</div>

<div class="card" style="position: relative;">
  <div class="card-header d-flex justify-content-between align-items-center">
    <h4 class="card-title mb-0">Receta</h4>
    <button type="button" class="btn btn-sm btn-outline-primary" (click)="addRecipeItem()">
      <i class="ri-add-line"></i> Agregar ingrediente
    </button>
  </div>

  <form [formGroup]="formGroupRecipe">
    <div class="card-body">
      <div class="table-responsive" style="overflow: visible !important;">
        <table class="table table-centered table-nowrap mb-0" style="overflow-y: visible !important;">
          <thead class="table-light">
            <tr>
              <th style="width: 45%;">Ingrediente</th>
              <th style="width: 20%;">Cantidad</th>
              <th style="width: 20%;">Costo</th>
              <th style="width: 15%;">Acción</th>
            </tr>
          </thead>

          <tbody formArrayName="recipeItems">
            @for (group of recipeItems.controls; track $index) {
            <tr [formGroupName]="$index">
              <td>
                <select selectFormInput [tigerValue]="resetEmitter" class="form-control" data-choices
                  data-choices-groups data-placeholder="Seleccione un ingrediente" formControlName="ingredientId">
                  <option value="">Seleccione un ingrediente</option>
                  @for (ing of ingredients; track ing.id) {
                  <option [value]="ing.id">{{ ing.name }}</option>
                  }
                </select>
              </td>

              <td class="d-flex align-items-center gap-2">
                <input type="text" class="form-control" mask="separator" [thousandSeparator]="'.'" [decimalMarker]="','"
                  placeholder="0,00" formControlName="quantity">
                <span>{{ getBaseUnitSymbol($index) }}</span>
              </td>

              <td>
                {{getCostValue($index ) | number : '1.2-2'}}
              </td>

              <td class="text-end">
                <button type="button" class="btn btn-danger btn-sm" (click)="removeRecipeItem($index)">
                  <i class="ri-delete-bin-5-line"></i>
                </button>
              </td>
            </tr>
            }
          </tbody>
        </table>
      </div>

      <!-- Total (opcional) -->
      <div class="mt-3 text-end">
        <strong>Total costo:</strong> {{ totalCost | number : '1.2-2' }}
      </div>
    </div>
  </form>
</div>



<div class="p-3 mb-3 rounded">
  <div class="row justify-content-end g-2">
    <div class="col-lg-3">
      <div class="btn btn-outline-secondary w-100"><i class="ri-close-circle-line"
          [routerLink]="['/products/listing']"></i> Cancelar</div>
    </div>
    <div class="col-lg-4" (click)="save()">
      <div class="btn btn-primary w-100" [ngClass]="formGroup.invalid ? 'btn-invalid' : ''"><i class="ri-save-line"></i>
        Guardar Cambios</div>
    </div>
  </div>
</div>
